import React, { useRef, useState, useEffect } from 'react'
import { Canvas, useFrame } from '@react-three/fiber'
import { OrbitControls, Text, Html, SoftShadows } from '@react-three/drei'
import { motion } from 'framer-motion'

// Single-file React component for a birthday greeting page.
// Uses TailwindCSS for layout. This file assumes a bundler with
// support for react-three-fiber, @react-three/drei and framer-motion.

export default function BirthdayGreeting() {
  const [started, setStarted] = useState(false)
  const [showCake, setShowCake] = useState(false)

  useEffect(() => {
    // After the terminal-typing intro finishes we reveal the cake
    if (started) {
      const t = setTimeout(() => setShowCake(true), 3200)
      return () => clearTimeout(t)
    }
  }, [started])

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-pink-900 to-indigo-800 text-white flex flex-col items-center justify-center p-6">
      <div className="w-full max-w-5xl bg-white/6 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border border-white/10">
        <div className="grid grid-cols-1 md:grid-cols-2">
          {/* Left: Terminal Intro + Controls */}
          <div className="p-8">
            <TerminalIntro started={started} onStart={() => setStarted(true)} />

            <div className="mt-6 flex gap-3">
              <button
                className="px-4 py-2 bg-pink-600 hover:bg-pink-500 rounded-md shadow-sm"
                onClick={() => setShowCake(s => !s)}
              >
                {showCake ? 'Hide Cake' : 'Show Cake'}
              </button>

              <button
                className="px-4 py-2 bg-emerald-500 hover:bg-emerald-400 rounded-md shadow-sm"
                onClick={() => window.scrollTo({ top: 9999, behavior: 'smooth' })}
              >
                Scroll to Wishes
              </button>
            </div>

            <div className="mt-8 text-sm text-white/80">
              <p>Made with ♥ — a little 3D scene, candle, and floating cherry blossoms.</p>
              <p className="mt-2">Tip: drag to rotate the cake. Use the button above to toggle it.</p>
            </div>
          </div>

          {/* Right: 3D Canvas */}
          <div className="h-96 md:h-[480px] relative">
            <Canvas shadows camera={{ position: [0, 3.5, 8], fov: 40 }}>
              <ambientLight intensity={0.6} />
              <directionalLight castShadow position={[5, 10, 5]} intensity={1} shadow-mapSize-width={1024} shadow-mapSize-height={1024} />

              <Scene showCake={showCake} />

              <OrbitControls enablePan={false} />
            </Canvas>

            {/* Birthday Wish overlay */}
            <div className="absolute left-4 bottom-4 bg-white/6 p-3 rounded-md border border-white/8">
              <div className="text-sm">Happy Birthday!</div>
              <div className="text-xs text-white/70">Tap and drag the 3D cake</div>
            </div>
          </div>
        </div>

        {/* Footer wishes */}
        <div className="p-6 border-t border-white/6 bg-gradient-to-t from-white/3 to-transparent">
          <motion.div initial={{ opacity: 0, y: 12 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}>
            <h3 className="text-2xl font-semibold">To the most wonderful one —</h3>
            <p className="mt-2 text-white/80">May your days be sweet, bright, and full of little surprises. I made this just for you ❤️</p>
          </motion.div>
        </div>
      </div>
    </div>
  )
}

function TerminalIntro({ started, onStart }) {
  const [text, setText] = useState('')
  const full = `// boot sequence...\n> loading birthday-greeting v1.0\n> decrypting happiness...\n> happy_birthday("you")\n\n// Press Enter to celebrate!`

  useEffect(() => {
    if (!started) return
    let i = 0
    const id = setInterval(() => {
      i++
      setText(full.slice(0, i))
      if (i >= full.length) clearInterval(id)
    }, 40)
    return () => clearInterval(id)
  }, [started])

  return (
    <div className="terminal bg-black/70 text-green-300 font-mono rounded-lg p-4 shadow-inner">
      <div className="flex items-center gap-2">
        <div className="h-3 w-3 rounded-full bg-red-500" />
        <div className="h-3 w-3 rounded-full bg-yellow-400" />
        <div className="h-3 w-3 rounded-full bg-green-400" />
      </div>

      <pre className="mt-3 text-sm whitespace-pre-wrap">{started ? text : '// Ready to run birthday sequence'}</pre>

      <div className="mt-4 flex gap-2">
        <button
          className="px-3 py-1 bg-slate-700/40 rounded text-white/90 hover:bg-slate-700"
          onClick={() => onStart()}
        >
          Run
        </button>

        <button
          className="px-3 py-1 bg-slate-700/30 rounded text-white/80"
          onClick={() => { setText(full); onStart() }}
        >
          Skip Anim
        </button>
      </div>
    </div>
  )
}

function Scene({ showCake }) {
  return (
    <group position={[0, -1.2, 0]}>
      <mesh receiveShadow rotation-x={-Math.PI / 2} position={[0, -0.01, 0]}>
        <planeGeometry args={[40, 40]} />
        <meshStandardMaterial color="#111827" />
      </mesh>

      <group position={[0, 0.6, 0]}>
        {showCake && <Cake />}
        <CherryBlossoms count={45} radius={3.2} />
      </group>
    </group>
  )
}

function Cake() {
  // Procedural "caramba ice cream cake" made from cylinders (cake layers) + spheres (scoops)
  const group = useRef()
  useFrame((state, delta) => {
    if (group.current) group.current.rotation.y += delta * 0.12
  })

  return (
    <group ref={group} castShadow>
      {/* Plate */}
      <mesh position={[0, -0.25, 0]} receiveShadow>
        <cylinderGeometry args={[2.2, 2.2, 0.08, 64]} />
        <meshStandardMaterial color="#f3f4f6" metalness={0.2} roughness={0.6} />
      </mesh>

      {/* Cake base */}
      <mesh position={[0, 0, 0]} castShadow>
        <cylinderGeometry args={[1.6, 1.6, 0.9, 64]} />
        <meshStandardMaterial color="#ffddcc" roughness={0.6} />
      </mesh>

      {/* Chocolate drip */}
      <mesh position={[0, 0.45, 0]}>
        <cylinderGeometry args={[1.62, 1.62, 0.1, 64]} />
        <meshStandardMaterial color="#5b2c20" metalness={0.1} roughness={0.6} />
      </mesh>

      {/* Scoops around the top */}
      {[-1, -0.5, 0, 0.5, 1].map((x, i) => (
        <mesh key={i} position={[x * 0.8, 0.9, Math.sin(i) * 0.6]} castShadow>
          <sphereGeometry args={[0.35, 32, 32]} />
          <meshStandardMaterial color={i % 2 === 0 ? '#ffd1dc' : '#fff2b2'} metalness={0.05} roughness={0.5} />
        </mesh>
      ))}

      {/* Candle */}
      <group position={[0, 1.2, 0]}>
        <mesh position={[0, 0, 0]} castShadow>
          <cylinderGeometry args={[0.06, 0.06, 0.7, 16]} />
          <meshStandardMaterial color="#ffffff" />
        </mesh>
        {/* flame */}
        <mesh position={[0, 0.5, 0]}>
          <coneGeometry args={[0.12, 0.24, 16]} />
          <meshStandardMaterial emissive={'#ffb86b'} emissiveIntensity={2} color={'#ff7a18'} />
        </mesh>
      </group>

      {/* Decorative cherry on top */}
      <mesh position={[0.6, 1.05, -0.3]} castShadow>
        <sphereGeometry args={[0.12, 16, 16]} />
        <meshStandardMaterial color={'#c81d25'} metalness={0.2} roughness={0.4} />
      </mesh>

      {/* Small text label */}
      <Text position={[0, -0.6, 0]} fontSize={0.18} color="#ffffff">
        Caramba Cake
      </Text>
    </group>
  )
}

function CherryBlossoms({ count = 40, radius = 3 }) {
  const group = useRef()
  useFrame((state, delta) => {
    if (group.current) group.current.rotation.y += delta * 0.02
  })

  return (
    <group ref={group}>
      {new Array(count).fill().map((_, i) => {
        const ang = (i / count) * Math.PI * 2
        const r = radius * (0.6 + Math.random() * 0.6)
        const x = Math.cos(ang) * r
        const z = Math.sin(ang) * r
        const y = 0.8 + Math.random() * 1.5
        const s = 0.08 + Math.random() * 0.12
        return (
          <mesh key={i} position={[x, y, z]} rotation={[Math.random(), Math.random(), Math.random()]}>
            <planeGeometry args={[s, s]} />
            <meshStandardMaterial transparent opacity={0.95} side={2} color={`#ffd1e6`} />
          </mesh>
        )
      })}
    </group>
  )
}
